"use strict";var SMS=require("../startup/sms_send");require("dotenv/config");var _require=require("../config/index"),JWT_SECRET=_require.JWT_SECRET,bcrypt=require("bcryptjs"),cookie=require("cookie"),jwt=require("jsonwebtoken"),User=require("../models/stackholders/user");setToken=function(e){return jwt.sign({iat:(new Date).getTime(),userId:e._id.toString()},process.env.JWT_SECRET)},generateOTP=function(){for(var e="",t=0;t<4;t++)e+="0123456789"[Math.floor(10*Math.random())];return e},exports.signup=function(t,r,n){var s,a,o,u,p,c,d,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("sign up"),s=t.body.name,a=parseInt(t.body.phone),o=t.body.password,u=t.body.address,p=t.body.fcmToken?t.body.fcmToken:"",e.next=8,regeneratorRuntime.awrap(bcrypt.hash(o,12));case 8:return hashedPassword=e.sent,e.prev=9,e.next=12,regeneratorRuntime.awrap(User.findOne({phone:a}));case 12:if(e.sent)throw(c=new Error("user phone existed")).statusCode=401,c;e.next=17;break;case 17:return(d=new User({name:s,phone:a,methods:["phone"],local:{password:hashedPassword},address:u,fcmToken:p})).otpVerified=!0,e.next=21,regeneratorRuntime.awrap(d.save());case 21:return i=setToken(d),e.abrupt("return",r.status(201).json({message:"Success",token:i}));case 25:e.prev=25,e.t0=e.catch(9),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 29:case"end":return e.stop()}},null,null,[[9,25]])},exports.login=function(t,r,n){var s,a,o,u,p,c,d;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=parseInt(t.body.phone),a=t.body.password,e.prev=2,e.next=5,regeneratorRuntime.awrap(User.findOne({phone:s}));case 5:if(o=e.sent){e.next=10;break}throw(u=new Error("user not found")).statusCode=401,u;case 10:return e.next=12,regeneratorRuntime.awrap(bcrypt.compare(a,o.local.password));case 12:if(isEqual=e.sent,isEqual){e.next=17;break}throw(p=new Error("Wrong password")).statusCode=401,p;case 17:return(c=t.body.fcmToken)||o.fcmToken?c&&(o.fcmToken=c):o.fcmToken=void 0,e.next=21,regeneratorRuntime.awrap(o.save());case 21:return d=setToken(o),r.cookie("jwt",d,{maxAge:3600,httpOnly:!0,secure:!0}),r.setHeader("Set-Cookie",cookie.serialize("token",d,{httpOnly:!0,maxAge:604800})),e.abrupt("return",r.status(200).json({message:"Logged in successfully",admin:o.admin,owner:o.owner,shipper:o.shipper,store:o.store,token:d}));case 27:e.prev=27,e.t0=e.catch(2),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 31:case"end":return e.stop()}},null,null,[[2,27]])},exports.resetPassword=function(t,r,n){var s,a,o,u,p,c,d,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("reset password"),s=parseInt(t.body.phone),e.prev=2,e.next=5,regeneratorRuntime.awrap(User.findOne({phone:s}));case 5:if(a=e.sent){e.next=10;break}throw(o=new Error("user not found")).statusCode=400,o;case 10:return u=generateOTP(),e.next=13,regeneratorRuntime.awrap(SMS.send(a.phone,"Your MotoBar OTP is ".concat(u)));case 13:if(!(p=e.sent)){e.next=30;break}if(p[0]&&"success"===p[0].type)return a.otp=u,a.otpVerified=!1,a.resetPassword=!0,e.next=21,regeneratorRuntime.awrap(a.save());e.next=25;break;case 21:return c=setToken(a),e.abrupt("return",r.status(201).json({message:"Success",token:c}));case 25:throw(d=new Error(p.error.msg)).statusCode=400,d;case 28:e.next=33;break;case 30:throw(i=new Error("Failed to send OTP")).statusCode=400,i;case 33:e.next=39;break;case 35:e.prev=35,e.t0=e.catch(2),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 39:case"end":return e.stop()}},null,null,[[2,35]])},exports.verifyOtp=function(t,r,n){var s,a,o,u,p,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=parseInt(t.body.phone),a=parseInt(t.body.otp),e.prev=2,e.next=5,regeneratorRuntime.awrap(User.findOne({phone:s}));case 5:if(o=e.sent){e.next=10;break}throw(u=new Error("user not found")).statusCode=400,u;case 10:if(console.log(o),console.log(o.otp),console.log(a),o.otp!==a)throw(p=new Error("Invalid OTP")).statusCode=400,p;e.next=17;break;case 17:return o.otp=void 0,o.otpVerified=!0,e.next=21,regeneratorRuntime.awrap(o.save());case 21:return c=setToken(o),e.abrupt("return",r.status(201).json({message:"Success",token:c}));case 25:e.prev=25,e.t0=e.catch(2),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 29:case"end":return e.stop()}},null,null,[[2,25]])},exports.resendOtp=function(t,r,n){var s,a,o,u,p,c,d,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("resend otp"),s=parseInt(t.body.phone),e.prev=2,e.next=5,regeneratorRuntime.awrap(User.findOne({phone:s}));case 5:if(a=e.sent){e.next=10;break}throw(o=new Error("user not found")).statusCode=400,o;case 10:return u=generateOTP(),e.next=13,regeneratorRuntime.awrap(SMS.send(a.phone,"Your MotoBar OTP is ".concat(u)));case 13:if(!(p=e.sent)){e.next=29;break}if(p[0]&&"success"===p[0].type)return a.otp=u,a.otpVerified=!1,e.next=20,regeneratorRuntime.awrap(a.save());e.next=24;break;case 20:return c=setToken(a),e.abrupt("return",r.status(201).json({message:"Success",token:c}));case 24:throw(d=new Error(p.error.msg)).statusCode=400,d;case 27:e.next=32;break;case 29:throw(i=new Error("Failed to send OTP")).statusCode=400,i;case 32:e.next=38;break;case 34:e.prev=34,e.t0=e.catch(2),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 38:case"end":return e.stop()}},null,null,[[2,34]])},exports.apple=function(t,r,n){var s,a,o,u,p,c,d,i,l;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.body.email,a=t.body.name,o=t.body.fcmToken,e.prev=3,e.next=6,regeneratorRuntime.awrap(User.findOne({"apple.email":s}));case 6:if(u=e.sent)return p=setToken(u),e.abrupt("return",r.status(200).json({message:"Logged in successfully",admin:u.admin,owner:u.owner,token:p}));e.next=10;break;case 10:return e.next=12,regeneratorRuntime.awrap(User.findOne({$or:[{"google.email":s},{"facebook.email":s}]}));case 12:if(c=e.sent)return c.methods.includes("apple")||c.methods.push("apple"),c.apple={email:s},e.next=18,regeneratorRuntime.awrap(c.save());e.next=20;break;case 18:return d=setToken(c),e.abrupt("return",r.status(200).json({message:"Logged in successfully",admin:c.admin,owner:c.owner,token:d}));case 20:return(i=new User({name:a,methods:["apple"],apple:{email:s},fcmToken:o})).otpVerified=!1,e.next=24,regeneratorRuntime.awrap(i.save());case 24:return l=setToken(i),e.abrupt("return",r.status(200).json({message:"Logged in successfully",token:l}));case 28:e.prev=28,e.t0=e.catch(3),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 32:case"end":return e.stop()}},null,null,[[3,28]])},exports.syncApple=function(t,r,n){var s,a,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.body.email,t.body.name,e.prev=2,a=t.user,e.next=6,regeneratorRuntime.awrap(User.findById(a._id).populate({path:"ownerId",model:"Owner",populate:{path:"store",model:"Store"}}).populate({path:"shipperId",model:"Shipper"}).populate({path:"leaderId",model:"Leader",populate:{path:"group",model:"Group"}}).populate({path:"products",model:"Product"}).populate({path:"orders",model:"Order"}).populate({path:"soldOrders",model:"Order"}));case 6:return(o=e.sent).methods.includes("apple")||o.methods.push("apple"),o.apple={email:s},e.next=11,regeneratorRuntime.awrap(o.save());case 11:return e.abrupt("return",r.status(200).json({message:"Logged in successfully",data:o}));case 14:e.prev=14,e.t0=e.catch(2),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 18:case"end":return e.stop()}},null,null,[[2,14]])},exports.google=function(t,r,n){var s,a,o,u,p,c,d,i,l,m;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.body.id,a=t.body.email,o=t.body.name,u=t.body.fcmToken,e.prev=4,e.next=7,regeneratorRuntime.awrap(User.findOne({"google.id":s}));case 7:if(p=e.sent)return c=setToken(p),e.abrupt("return",r.status(200).json({message:"Logged in successfully",admin:p.admin,owner:p.owner,token:c}));e.next=11;break;case 11:return e.next=13,regeneratorRuntime.awrap(User.findOne({$or:[{"apple.email":a},{"facebook.email":a}]}));case 13:if(d=e.sent)return d.methods.includes("google")||d.methods.push("google"),d.google={id:s,email:a},e.next=19,regeneratorRuntime.awrap(d.save());e.next=21;break;case 19:return i=setToken(d),e.abrupt("return",r.status(200).json({message:"Logged in successfully",admin:d.admin,owner:d.owner,token:i}));case 21:return(l=new User({name:o,methods:["google"],google:{id:s,email:a},fcmToken:u})).otpVerified=!1,e.next=25,regeneratorRuntime.awrap(l.save());case 25:return m=setToken(l),e.abrupt("return",r.status(200).json({message:"Logged in successfully",token:m}));case 29:e.prev=29,e.t0=e.catch(4),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 33:case"end":return e.stop()}},null,null,[[4,29]])},exports.syncGoogle=function(t,r,n){var s,a,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.body.id,a=t.body.email,t.body.name,e.prev=3,o=t.user,e.next=7,regeneratorRuntime.awrap(User.findById(o._id).populate({path:"ownerId",model:"Owner",populate:{path:"store",model:"Store"}}).populate({path:"shipperId",model:"Shipper"}).populate({path:"leaderId",model:"Leader",populate:{path:"group",model:"Group"}}).populate({path:"products",model:"Product"}).populate({path:"orders",model:"Order"}).populate({path:"soldOrders",model:"Order"}));case 7:return(u=e.sent).methods.includes("google")||u.methods.push("google"),u.google={id:s,email:a},e.next=12,regeneratorRuntime.awrap(u.save());case 12:return e.abrupt("return",r.status(200).json({message:"Logged in successfully",data:u}));case 15:e.prev=15,e.t0=e.catch(3),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 19:case"end":return e.stop()}},null,null,[[3,15]])},exports.facebook=function(t,r,n){var s,a,o,u,p,c,d,i,l,m,g;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.body.id,a=t.body.email,o=t.body.name,u=t.body.image,p=t.body.fcmToken,e.prev=5,e.next=8,regeneratorRuntime.awrap(User.findOne({"facebook.id":s}));case 8:if(c=e.sent)return c.image=u,e.next=13,regeneratorRuntime.awrap(c.save());e.next=15;break;case 13:return d=setToken(c),e.abrupt("return",r.status(200).json({message:"Logged in successfully",admin:c.admin,owner:c.owner,token:d}));case 15:return e.next=17,regeneratorRuntime.awrap(User.findOne({$or:[{"apple.email":a},{"google.email":a}]}));case 17:if(i=e.sent)return i.methods.includes("facebook")||i.methods.push("facebook"),i.facebook={id:s,email:a},i.image=u,e.next=24,regeneratorRuntime.awrap(i.save());e.next=26;break;case 24:return l=setToken(i),e.abrupt("return",r.status(200).json({message:"Logged in successfully",admin:i.admin,owner:i.owner,token:l}));case 26:return(m=new User({name:o,image:u,methods:["facebook"],facebook:{id:s,email:a},fcmToken:p})).otpVerified=!1,e.next=30,regeneratorRuntime.awrap(m.save());case 30:return g=setToken(m),e.abrupt("return",r.status(200).json({message:"Logged in successfully",token:g}));case 34:e.prev=34,e.t0=e.catch(5),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 38:case"end":return e.stop()}},null,null,[[5,34]])},exports.syncFacebook=function(t,r,n){var s,a,o,u,p;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.body.id,a=t.body.email,t.body.name,o=t.body.image,e.prev=4,u=t.user,e.next=8,regeneratorRuntime.awrap(User.findById(u._id).populate({path:"ownerId",model:"Owner",populate:{path:"store",model:"Store"}}).populate({path:"shipperId",model:"Shipper"}).populate({path:"leaderId",model:"Leader",populate:{path:"group",model:"Group"}}).populate({path:"products",model:"Product"}).populate({path:"orders",model:"Order"}).populate({path:"soldOrders",model:"Order"}));case 8:return(p=e.sent).methods.includes("facebook")||p.methods.push("facebook"),p.facebook={id:s,email:a},p.image=o,e.next=14,regeneratorRuntime.awrap(p.save());case 14:return e.abrupt("return",r.status(200).json({message:"Logged in successfully",data:p}));case 17:e.prev=17,e.t0=e.catch(4),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 21:case"end":return e.stop()}},null,null,[[4,17]])},exports.getProfile=function(t,r,n){var s,a,o,u,p,c,d;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.get("Authorization")){e.next=5;break}throw(a=new Error("Not Authenticated.")).statusCode=401,a;case 5:o=s.split(" ")[1],e.prev=6,u=jwt.verify(o,process.env.JWT_SECRET),e.next=14;break;case 10:throw e.prev=10,e.t0=e.catch(6),e.t0.statusCode=500,e.t0;case 14:if(u){e.next=18;break}throw(p=new Error("Not Authenticated.")).statusCode=401,p;case 18:return e.prev=18,e.next=21,regeneratorRuntime.awrap(User.findById(u.userId).populate({path:"ownerId",model:"Owner",populate:{path:"store",model:"Store"}}).populate({path:"shipperId",model:"Shipper"}).populate({path:"leaderId",model:"Leader",populate:{path:"group",model:"Group"}}).populate({path:"products",model:"Product"}).populate({path:"orders",model:"Order"}).populate({path:"soldOrders",model:"Order"}));case 21:if(c=e.sent){e.next=26;break}throw(d=new Error("Could not find user.")).statusCode=404,d;case 26:return e.abrupt("return",r.status(200).json({message:"Profile fetched.",data:c}));case 29:e.prev=29,e.t1=e.catch(18),e.t1.statusCode||(e.t1.statusCode=500),n(e.t1);case 33:case"end":return e.stop()}},null,null,[[6,10],[18,29]])},exports.facebookOAuth=function(t,r,n){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=setToken(t.user),e.abrupt("return",r.status(201).json({message:"Success",user:t.user,token:s}));case 5:e.prev=5,e.t0=e.catch(0),e.t0.statusCode||(e.t0.statusCode=500),n(e.t0);case 9:case"end":return e.stop()}},null,null,[[0,5]])},exports.googleOAuth=function(t,r,n){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:try{s=setToken(t.user),r.status(201).json({message:"Success",user:t.user,token:s})}catch(e){e.statusCode||(e.statusCode=500),n(e)}case 1:case"end":return e.stop()}})};
//# sourceMappingURL=auth.min.js.map
